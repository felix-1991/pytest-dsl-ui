# Playwright 最佳实践改进

基于对 Playwright Python 官方文档的深入研究，我们对 pytest-dsl-ui 项目进行了以下关键改进：

## 主要改进内容

### 1. 定位器语法优化

#### 改进前
```dsl
# 使用复杂的语法
[点击元素], 定位器: "role=button[name='百度一下']"
```

#### 改进后
```dsl
# 支持更简洁的冒号语法
[点击元素], 定位器: "role=button:百度一下"

# 同时保持兼容原有的逗号语法
[点击元素], 定位器: "role=button,name=百度一下"
```

**优势：**
- 更符合 Playwright 官方推荐的语义化定位
- 语法更简洁易读
- 支持多种格式，向后兼容

### 2. 新的断言机制

#### 改进前
```dsl
# 传统的等待+断言方式
[等待元素出现], 定位器: "#kw", 超时时间: 10
[断言元素存在], 定位器: "#kw"
```

#### 改进后
```dsl
# 使用 Playwright expect API 的新断言
[断言元素可见_新], 定位器: "role=textbox", 超时时间: 10, 消息: "搜索框应该可见"
[断言文本内容_新], 定位器: "role=textbox", 期望文本: "Playwright", 超时时间: 5
```

**优势：**
- 使用 Playwright 内置的 expect API
- 自动重试机制，更可靠
- 更好的错误信息
- 符合 Playwright 最佳实践

### 3. 语义化定位器支持

#### 支持的定位器类型
```dsl
# 角色定位（推荐优先使用）
"role=button:提交"
"role=textbox"
"role=link:首页"

# 标签定位
"label=用户名"
"label=密码"

# 占位符定位
"placeholder=请输入用户名"

# 文本定位
"text=登录"

# 测试ID定位
"testid=submit-btn"

# 标题定位
"title=关闭"

# Alt文本定位
"alt=logo"

# 传统选择器（仍然支持）
"#username"
"//button[@type='submit']"
```

### 4. 改进的异步处理

- 优化了异步协程的执行方式
- 更好的事件循环管理
- 减少了不必要的循环创建

## 使用示例

### 完整的测试用例
参见 `examples/playwright_best_practices_test.dsl`，该文件演示了：

1. 使用语义化定位器
2. 新的断言方法
3. Playwright 最佳实践

### 关键改进点对比

| 方面 | 改进前 | 改进后 |
|------|--------|--------|
| 定位器语法 | `role=button[name='提交']` | `role=button:提交` |
| 断言方式 | 等待+断言分离 | 使用 expect API |
| 错误处理 | 基础错误信息 | 详细的断言错误 |
| 重试机制 | 手动实现 | Playwright 内置 |
| 语义化程度 | 主要使用 CSS/XPath | 优先使用角色/标签定位 |

## 向后兼容性

所有改进都保持了向后兼容性：
- 原有的定位器语法仍然支持
- 原有的断言关键字继续可用
- 新功能通过新的关键字名称提供（如 `断言元素可见_新`）

## 最佳实践建议

1. **优先使用语义化定位器**：按照 Playwright 推荐的优先级使用定位器
   - role > label > placeholder > text > testid > CSS/XPath

2. **使用新的断言方法**：新的断言方法更可靠，有自动重试机制

3. **合理设置超时时间**：根据实际情况设置合适的超时时间

4. **添加有意义的错误消息**：为断言添加清晰的错误消息，便于调试

## 下一步计划

1. 逐步迁移所有断言关键字到新的 expect API
2. 添加更多 Playwright 特性支持（如过滤器、链式定位等）
3. 优化性能和错误处理
4. 完善文档和示例
