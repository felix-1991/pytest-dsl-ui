# pytest-dsl-ui å¤ç”¨å’Œæ‰©å±•æ“ä½œæŒ‡å—


## ğŸš€ å¤ç”¨æ–¹æ¡ˆè¯¦è§£


### æ‰©å±•åŒ…æ¨¡å¼ (æ¨èç”¨äºåŠŸèƒ½æ‰©å±•)

**é€‚ç”¨åœºæ™¯**:
- ä¿æŒåŸæ¡†æ¶ä¸å˜
- åˆ›å»ºå¯å¤ç”¨çš„æ‰©å±•åŒ…
- å›¢é˜Ÿåä½œå¼€å‘

**å®Œæ•´ç¤ºä¾‹** (å·²åœ¨ `extension_example` ç›®å½•ä¸­æä¾›):

1. **é¡¹ç›®ç»“æ„**
```
your-ui-extension/
â”œâ”€â”€ pyproject.toml              # é¡¹ç›®é…ç½®
â”œâ”€â”€ README.md                   # ä½¿ç”¨æ–‡æ¡£
â”œâ”€â”€ your_ui_extension/
â”‚   â”œâ”€â”€ __init__.py            # ä¸»å…¥å£
â”‚   â”œâ”€â”€ keywords/
â”‚   â”‚   â”œâ”€â”€ __init__.py       # å…³é”®å­—æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ custom_keywords.py # è‡ªå®šä¹‰å…³é”®å­—
â”‚   â”‚   â””â”€â”€ advanced_keywords.py # é«˜çº§å…³é”®å­—
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ helpers.py         # è¾…åŠ©å·¥å…·
```

2. **å…³é”®é…ç½®ç‚¹**
```toml
# pyproject.toml ä¸­çš„å…³é”®é…ç½®
[project.entry-points."pytest_dsl.keywords"]
your_extension = "your_ui_extension"
```

3. **å®‰è£…å’Œä½¿ç”¨**
```bash
pip install your-ui-extension
# è‡ªåŠ¨æ³¨å†Œï¼Œç›´æ¥åœ¨DSLä¸­ä½¿ç”¨æ–°å…³é”®å­—
```

## ğŸ”§ æ‰©å±•æ–°UIå…³é”®å­—çš„æ ‡å‡†æ¨¡å¼

### 1. å…³é”®å­—å®ç°æ¨¡æ¿

```python
from pytest_dsl.core.keyword_manager import keyword_manager
from pytest_dsl_ui.core.browser_manager import browser_manager
from pytest_dsl_ui.core.element_locator import ElementLocator
import allure
import logging

logger = logging.getLogger(__name__)

@keyword_manager.register('å…³é”®å­—åç§°', [
    {'name': 'å‚æ•°å', 'mapping': 'param_mapping', 'description': 'å‚æ•°æè¿°', 'default': None},
])
def your_keyword(**kwargs):
    """å…³é”®å­—åŠŸèƒ½æè¿°
    
    Args:
        param_mapping: å‚æ•°è¯´æ˜
    
    Returns:
        dict: æ ‡å‡†è¿”å›æ ¼å¼
    """
    # è·å–å‚æ•°
    param_value = kwargs.get('param_mapping')
    context = kwargs.get('context')
    
    with allure.step("å…³é”®å­—æ‰§è¡Œæ­¥éª¤"):
        try:
            # è·å–å½“å‰é¡µé¢
            page_id = context.get('current_page_id') if context else None
            page = browser_manager.get_page(page_id)
            locator = ElementLocator(page)
            
            # å®ç°å…·ä½“é€»è¾‘
            # ...
            
            # AllureæŠ¥å‘Š
            allure.attach(
                "æ‰§è¡Œç»“æœä¿¡æ¯",
                name="æ“ä½œè¯¦æƒ…",
                attachment_type=allure.attachment_type.TEXT
            )
            
            # æ—¥å¿—è®°å½•
            logger.info(f"å…³é”®å­—æ‰§è¡ŒæˆåŠŸ")
            
            # æ ‡å‡†è¿”å›æ ¼å¼
            return {
                "result": execution_result,
                "captures": {
                    # ä¿å­˜åˆ°ä¸Šä¸‹æ–‡çš„å˜é‡
                    'variable_name': value
                },
                "session_state": {},
                "metadata": {
                    "operation": "your_keyword",
                    "additional_info": "value"
                }
            }
            
        except Exception as e:
            logger.error(f"å…³é”®å­—æ‰§è¡Œå¤±è´¥: {str(e)}")
            allure.attach(
                f"é”™è¯¯ä¿¡æ¯: {str(e)}",
                name="æ‰§è¡Œå¤±è´¥",
                attachment_type=allure.attachment_type.TEXT
            )
            raise
```

### 2. å¸¸è§åŠŸèƒ½å®ç°æ¨¡å¼

#### A. å…ƒç´ æ“ä½œç±»å…³é”®å­—
```python
@keyword_manager.register('æ™ºèƒ½ç‚¹å‡»', [
    {'name': 'å®šä½å™¨', 'mapping': 'selector', 'description': 'å…ƒç´ é€‰æ‹©å™¨'},
    {'name': 'é‡è¯•æ¬¡æ•°', 'mapping': 'retry_count', 'default': 3},
])
def smart_click(**kwargs):
    selector = kwargs.get('selector')
    retry_count = kwargs.get('retry_count', 3)
    context = kwargs.get('context')
    
    page = browser_manager.get_page(context.get('current_page_id'))
    locator = ElementLocator(page)
    
    for i in range(retry_count):
        try:
            element = locator.locate(selector)
            element.click()
            return {"result": True}
        except Exception as e:
            if i == retry_count - 1:
                raise
            time.sleep(1)
```

#### B. æ•°æ®å¤„ç†ç±»å…³é”®å­—
```python
@keyword_manager.register('æå–è¡¨æ ¼æ•°æ®', [
    {'name': 'è¡¨æ ¼é€‰æ‹©å™¨', 'mapping': 'table_selector'},
    {'name': 'è¾“å‡ºå˜é‡', 'mapping': 'output_var', 'default': 'table_data'},
])
def extract_table_data(**kwargs):
    table_selector = kwargs.get('table_selector')
    output_var = kwargs.get('output_var', 'table_data')
    context = kwargs.get('context')
    
    page = browser_manager.get_page(context.get('current_page_id'))
    
    # æå–è¡¨æ ¼æ•°æ®é€»è¾‘
    table_data = page.evaluate(f"""
        () => {{
            const table = document.querySelector('{table_selector}');
            // æå–é€»è¾‘...
            return data;
        }}
    """)
    
    return {
        "result": table_data,
        "captures": {output_var: table_data}
    }
```

#### C. ç­‰å¾…å’ŒéªŒè¯ç±»å…³é”®å­—
```python
@keyword_manager.register('ç­‰å¾…æ¡ä»¶æ»¡è¶³', [
    {'name': 'æ¡ä»¶è¡¨è¾¾å¼', 'mapping': 'condition'},
    {'name': 'è¶…æ—¶æ—¶é—´', 'mapping': 'timeout', 'default': 30},
])
def wait_for_condition(**kwargs):
    condition = kwargs.get('condition')
    timeout = kwargs.get('timeout', 30)
    context = kwargs.get('context')
    
    page = browser_manager.get_page(context.get('current_page_id'))
    
    try:
        page.wait_for_function(condition, timeout=timeout*1000)
        return {"result": True}
    except Exception:
        return {"result": False}
```

## ğŸ“š å®é™…æ“ä½œç¤ºä¾‹

### ç¤ºä¾‹1: ä¸ºç”µå•†é¡¹ç›®æ·»åŠ ä¸“ç”¨å…³é”®å­—

```python
# ecommerce_ui_keywords.py
@keyword_manager.register('æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦', [
    {'name': 'å•†å“ID', 'mapping': 'product_id'},
    {'name': 'æ•°é‡', 'mapping': 'quantity', 'default': 1},
])
def add_to_cart(**kwargs):
    product_id = kwargs.get('product_id')
    quantity = kwargs.get('quantity', 1)
    context = kwargs.get('context')
    
    page = browser_manager.get_page(context.get('current_page_id'))
    locator = ElementLocator(page)
    
    # å¯¼èˆªåˆ°å•†å“é¡µé¢
    page.goto(f"/product/{product_id}")
    
    # è®¾ç½®æ•°é‡
    quantity_input = locator.locate('input[name="quantity"]')
    quantity_input.fill(str(quantity))
    
    # ç‚¹å‡»æ·»åŠ åˆ°è´­ç‰©è½¦
    add_button = locator.locate('button:has-text("æ·»åŠ åˆ°è´­ç‰©è½¦")')
    add_button.click()
    
    # ç­‰å¾…æˆåŠŸæç¤º
    success_msg = locator.wait_for_element('.success-message', timeout=10)
    
    return {
        "result": True,
        "captures": {
            'cart_item_added': {'product_id': product_id, 'quantity': quantity}
        }
    }
```

### ç¤ºä¾‹2: ä¸ºåå°ç®¡ç†ç³»ç»Ÿæ·»åŠ æ‰¹é‡æ“ä½œ

```python
# admin_ui_keywords.py
@keyword_manager.register('æ‰¹é‡ç”¨æˆ·æ“ä½œ', [
    {'name': 'ç”¨æˆ·IDåˆ—è¡¨', 'mapping': 'user_ids'},
    {'name': 'æ“ä½œç±»å‹', 'mapping': 'action'},  # 'activate', 'deactivate', 'delete'
])
def batch_user_operation(**kwargs):
    user_ids = kwargs.get('user_ids', [])
    action = kwargs.get('action')
    context = kwargs.get('context')
    
    page = browser_manager.get_page(context.get('current_page_id'))
    locator = ElementLocator(page)
    
    results = []
    
    for user_id in user_ids:
        try:
            # é€‰ä¸­ç”¨æˆ·å¤é€‰æ¡†
            checkbox = locator.locate(f'input[value="{user_id}"]')
            checkbox.check()
            results.append({'user_id': user_id, 'selected': True})
        except Exception as e:
            results.append({'user_id': user_id, 'selected': False, 'error': str(e)})
    
    # æ‰§è¡Œæ‰¹é‡æ“ä½œ
    action_button = locator.locate(f'button[data-action="{action}"]')
    action_button.click()
    
    # ç¡®è®¤æ“ä½œ
    confirm_button = locator.locate('button:has-text("ç¡®è®¤")')
    confirm_button.click()
    
    return {
        "result": results,
        "captures": {
            'batch_operation_result': {
                'action': action,
                'total_users': len(user_ids),
                'results': results
            }
        }
    }
```



è¿™ä¸ªæŒ‡å—æä¾›äº†æ‰©å±•çš„å®Œæ–¹æ¡ˆï¼Œæ‚¨å¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ–¹å¼è¿›è¡Œé¡¹ç›®å¤ç”¨å’Œæ‰©å±•ã€‚ 